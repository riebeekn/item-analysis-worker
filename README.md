# Item Analysis worker

A spike / experimental project that uses R and Ruby to generate a PDF item analysis report.  Multiple worker processes can be deployed to Heroku therefore distributing a queue of requests between multiple workers.  The workers poll a Postgres database for new requests, picking off new requests as they come in.  

Intermediate and final output files are uploaded to Amazon S3.  Inputs consist of a CSV data file containg participant responses and a key file indicating the correct selection.

## Installation (local)
* Set-up the local database via the script located in the [Item analysis web](https://github.com/riebeekn/item-analysis-UI-rails) application.
* Copy /config/heroku_env.rb.template to heroku_env.rb and adjust the values accordingly.
* Update /db/config.yml with the appropriate database settings from step 1.
* The application can run a single job for testing purposes via the /app/console/run_job.rb script: 
```
$ ruby app/console/run_job.rb
``` 
&nbsp;&nbsp;&nbsp;or 
```
$ ruby app/console/run_job.rb --filename "./sample_data_files/50q_30p.csv"
```

* To start up a worker process so that it monitors the database for new requests instead of running a single job, run the /app/worker/worker.rb script:
```
$ ruby app/worker/worker.rb
```

* Rspec tests can be run as usual via:
```
$ rspec spec/
```

## Installation (Heroku)
The Heroku installation installs both R and Ruby on Heroku, using a custom [buildpack](https://github.com/riebeekn/heroku-buildpack-r) to install R, along with the [multi-buildpack](https://github.com/ddollar/heroku-buildpack-multi) so that Ruby can also be installed.

Installation on Heroku is fairly straight-forward but requires an existing instance of the [Item analysis web](https://github.com/riebeekn/item-analysis-UI-rails) application is already installed on Heroku.  This is due to the item analysis worker application using the database set-up by the web application.

To install the worker on Heroku:

* Run the install script, filling in the appropriate values:

```
$ ./install |worker-name| |app name to take db info from| |aws bucket| |aws key| |aws secret|
```

* Descriptions of the parameters that get passed into the script are:
    * worker-name - the name of the Heroku application to create.
    * app name to take db info from - the application which hosts the database, i.e. the app name of the [Item analysis web](https://github.com/riebeekn/item-analysis-UI-rails) application that was deployed to Heroku.
    * aws bucket - the AWS bucket to store the final output and temporary files generated by the worker process.
    * aws key - the AWS key for the AWS account in which the bucket lives.
    * aws secret - the AWS secret for the AWS account in which the bucket lives.
* An example of possible valid values for the script would be:

```
$ ./install.sh item-analysis-worker-1 item-analysis-ui my-aws-bucket my-aws-key my-aws-secret
```

### Altering the default configuration
The install scripts sets a number of environment variables on Heroku which can be altered if desired.  These can either be altered after the script has run or altered directly in the script so that the altered values become the new defaults whenever the script is run.  The most likely variables that would be altered are:

* WORKER_SLEEP_SECONDS - the seconds the worker sleeps before checking for any new job requests.
* RUN_MIRT - whether to run MIRT analysis, MIRT analysis adds significant processing time to a job.
* CLEAN_S3_TEMP - whether to remove temporary files from S3, setting to false can be useful for debugging.

The above setting can be altered via the Heroku config command, i.e.
```
$ heroku config:set RUN_MIRT=false --remote item-analysis-worker-1
```

By default each worker uses a single Dyno on Heroku, this can be adjusted per the normal Heroku command, i.e.

```
$ heroku ps:scale worker=0 --remote item-analysis-worker-1
```
